<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WIN5 抽選ツール（人気順）</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#121826;
      --panel2:#0f1522;
      --text:#e6edf3;
      --muted:#a9b4c0;
      --border:#253247;
      --accent:#3b82f6;
      --danger:#ef4444;
      --ok:#22c55e;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(59,130,246,.15), transparent 55%),
                  radial-gradient(900px 700px at 80% 30%, rgba(34,197,94,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(10px);
      background: rgba(11,15,20,.72);
      border-bottom:1px solid rgba(37,50,71,.5);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px}
    h1{
      font-size:16px; margin:0;
      letter-spacing:.02em;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .sub{
      font-size:12px; color:var(--muted); font-weight:500;
      white-space:nowrap;
    }

    main{max-width:1100px; margin:0 auto; padding:14px 14px 26px}

    .panel{
      background: linear-gradient(180deg, rgba(18,24,38,.92), rgba(15,21,34,.92));
      border:1px solid rgba(37,50,71,.65);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .controls{
      padding:14px;
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:flex-end; justify-content:space-between;
    }
    .controls .left{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 150px;
    }
    label{
      font-size:12px;
      color:var(--muted);
    }
    input[type="number"], select{
      appearance:none;
      border:1px solid rgba(37,50,71,.9);
      background: rgba(7,10,15,.55);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      font-size:14px;
      outline:none;
    }
    input[type="number"]:focus, select:focus{
      border-color: rgba(59,130,246,.9);
      box-shadow: 0 0 0 3px rgba(59,130,246,.20);
    }
    .btn{
      border:none;
      border-radius: 14px;
      padding:12px 16px;
      font-size:14px;
      font-weight:700;
      color: white;
      background: linear-gradient(180deg, rgba(59,130,246,1), rgba(37,99,235,1));
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(59,130,246,.25);
      min-width: 120px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(18,24,38,.6);
      border:1px solid rgba(37,50,71,.85);
      color: var(--text);
      box-shadow:none;
      font-weight:650;
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border:1px solid rgba(239,68,68,.45);
      color:#fecaca;
      box-shadow:none;
      font-weight:650;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:10px;
      margin-top:12px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: 1fr}
    }

    .race{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 180px;
    }
    .race .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .race .title{
      font-size:13px;
      color: var(--muted);
      font-weight:650;
    }
    .race .result{
      flex:1;
      background: rgba(7,10,15,.45);
      border:1px solid rgba(37,50,71,.65);
      border-radius: 14px;
      padding:10px 10px;
      overflow:auto;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:13px;
      line-height: 1.55;
      white-space: pre;
    }
    .race .bottom{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .race .bottom .field{min-width: 120px}

    .log{
      margin-top:12px;
      padding:14px;
    }
    .logHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logHead h2{
      margin:0;
      font-size:14px;
      letter-spacing:.01em;
    }
    .logHead .hint{
      margin:0;
      font-size:12px;
      color: var(--muted);
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(37,50,71,.65);
    }
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      padding:10px 10px;
      background: rgba(7,10,15,.55);
      border-bottom:1px solid rgba(37,50,71,.65);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(37,50,71,.35);
      vertical-align: top;
      font-size:13px;
    }
    tbody tr:last-child td{border-bottom:none}
    .ts{
      color:#cbd5e1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space:nowrap;
      font-size:12px;
    }
    .combo{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color: #e5e7eb;
      line-height:1.55;
      word-break: break-word;
    }
    .muted{color:var(--muted)}
    .checkbox{
      width:18px; height:18px;
      accent-color: var(--ok);
    }
    .logScroll{
      max-height: 380px;
      overflow:auto;
      border-radius: 14px;
    }

    .weights{
      margin-top:12px;
      padding:14px;
    }
    .weights h2{margin:0 0 10px 0; font-size:14px}
    .weightsGrid{
      display:grid;
      grid-template-columns: 220px 1fr 80px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 720px){
      .weightsGrid{grid-template-columns: 1fr}
    }
    input[type="range"]{
      width:100%;
    }
    .small{
      font-size:12px;
      color: var(--muted);
      margin:10px 0 0 0;
      line-height: 1.6;
    }
    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius: 999px;
      border:1px solid rgba(37,50,71,.65);
      background: rgba(7,10,15,.45);
      color: var(--muted);
      font-size:12px;
      font-weight:650;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>
        <span>WIN5 抽選ツール（人気順）</span>
        <span class="sub">スクレイピングなし / 人気1〜Nから重み付き抽選 / localStorage保存</span>
      </h1>
    </div>
  </header>

  <main>
    <section class="panel controls">
      <div class="left">
        <div class="field">
          <label for="ticketsPerDraw">抽選1回あたりの抽選数（通り数）</label>
          <input id="ticketsPerDraw" type="number" min="1" max="50" step="1" />
        </div>
      </div>
      <div class="right" style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
        <button id="drawBtn" class="btn">抽選</button>
        <button id="resetBtn" class="btn secondary" title="設定とログを初期化します">初期化</button>
      </div>
    </section>

    <section class="grid" id="racesGrid">
      <!-- JSで生成 -->
    </section>

    <section class="panel log">
      <div class="logHead">
        <div>
          <h2>抽選ログ</h2>
          <p class="hint">チェックは購入済みの目印です（端末内に保存されます）。</p>
        </div>
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
          <button id="clearChecksBtn" class="btn secondary" title="購入済みチェックをすべて外します">チェック全解除</button>
          <button id="deleteCheckedBtn" class="btn danger" title="購入済みにチェックした行を削除します">チェック行削除</button>
        </div>
      </div>

      <div class="logScroll">
        <table>
          <thead>
            <tr>
              <th style="width:74px;">購入</th>
              <th style="width:150px;">日時</th>
              <th>組み合わせ（人気）</th>
            </tr>
          </thead>
          <tbody id="logBody">
            <!-- JSで描画 -->
          </tbody>
        </table>
      </div>
      <p class="small">
        表示は人気番号です。即PATでは各レースの人気順を参照して、対応する馬番を選択してください。
      </p>
    </section>

    <section class="panel weights">
      <h2>重み設定 <span class="pill">基本触らない想定</span></h2>

      <div class="weightsGrid">
        <div class="field" style="min-width:220px">
          <label for="distType">分布タイプ</label>
          <select id="distType">
            <option value="exp">指数減衰（上位に強く集中）</option>
            <option value="power">べき乗（ゆるやかに集中）</option>
          </select>
        </div>

        <div class="field">
          <label id="distParamLabel" for="distParam">偏り（λ）</label>
          <input id="distParam" type="range" />
        </div>

        <div class="field" style="min-width:80px">
          <label>値</label>
          <div id="distParamValue" style="padding:10px 12px; border-radius:12px; border:1px solid rgba(37,50,71,.9); background:rgba(7,10,15,.55); font-family:ui-monospace, monospace; font-size:13px;"></div>
        </div>
      </div>

      <p class="small" id="distHelp"></p>
    </section>
  </main>

  <script>
    "use strict";

    const STORAGE_KEY = "win5_rng_state_v1";
    const MAX_LOG = 800; // localStorage肥大化を避けるため

    const DEFAULT_STATE = {
      version: 1,
      settings: {
        Ns: [10, 10, 10, 10, 10],
        ticketsPerDraw: 1,
        distType: "exp",
        distParam: 0.9, // exp: λ, power: s
      },
      lastDrawTickets: [], // [{ranks:[...], tsISO:"..."}]
      log: [] // newest first: [{id, tsISO, ranks:[5], purchased:boolean}]
    };

    let state = loadState();

    // ---------- UI生成 ----------
    const racesGrid = document.getElementById("racesGrid");
    const ticketsPerDrawEl = document.getElementById("ticketsPerDraw");
    const drawBtn = document.getElementById("drawBtn");
    const resetBtn = document.getElementById("resetBtn");

    const logBody = document.getElementById("logBody");
    const clearChecksBtn = document.getElementById("clearChecksBtn");
    const deleteCheckedBtn = document.getElementById("deleteCheckedBtn");

    const distTypeEl = document.getElementById("distType");
    const distParamEl = document.getElementById("distParam");
    const distParamLabelEl = document.getElementById("distParamLabel");
    const distParamValueEl = document.getElementById("distParamValue");
    const distHelpEl = document.getElementById("distHelp");

    const raceResultEls = [];
    const nSelectEls = [];

    function buildRaceCards() {
      racesGrid.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const card = document.createElement("section");
        card.className = "panel race";

        const top = document.createElement("div");
        top.className = "top";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = `レース ${i + 1}`;

        top.appendChild(title);

        const result = document.createElement("div");
        result.className = "result";
        result.textContent = "未抽選";
        raceResultEls[i] = result;

        const bottom = document.createElement("div");
        bottom.className = "bottom";

        const field = document.createElement("div");
        field.className = "field";
        const lab = document.createElement("label");
        lab.textContent = "抽選上限N（人気）";
        lab.setAttribute("for", `nSelect${i}`);

        const sel = document.createElement("select");
        sel.id = `nSelect${i}`;
        for (let n = 1; n <= 18; n++) {
          const opt = document.createElement("option");
          opt.value = String(n);
          opt.textContent = String(n);
          sel.appendChild(opt);
        }
        sel.value = String(state.settings.Ns[i] ?? 10);
        sel.addEventListener("change", () => {
          const v = clampInt(parseInt(sel.value, 10), 1, 18);
          state.settings.Ns[i] = v;
          saveState();
        });
        nSelectEls[i] = sel;

        field.appendChild(lab);
        field.appendChild(sel);

        bottom.appendChild(field);

        card.appendChild(top);
        card.appendChild(result);
        card.appendChild(bottom);

        racesGrid.appendChild(card);
      }
    }

    // ---------- 分布設定UI ----------
    function configureDistUIFromState() {
      distTypeEl.value = state.settings.distType;
      applyDistUIByType(state.settings.distType, state.settings.distParam);
    }

    function applyDistUIByType(type, param) {
      if (type === "exp") {
        distParamLabelEl.textContent = "偏り（λ：指数減衰）";
        distParamEl.min = "0";
        distParamEl.max = "2.0";
        distParamEl.step = "0.05";
        distParamEl.value = String(clampFloat(param, 0, 2.0));
        distHelpEl.textContent = "λを上げるほど、1番人気・2番人気が選ばれやすくなります（下位はたまに出る）。";
      } else {
        distParamLabelEl.textContent = "偏り（s：べき乗）";
        distParamEl.min = "0";
        distParamEl.max = "4.0";
        distParamEl.step = "0.1";
        distParamEl.value = String(clampFloat(param, 0, 4.0));
        distHelpEl.textContent = "sを上げるほど、上位人気が選ばれやすくなります（指数減衰よりゆるめ）。";
      }
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
    }

    function formatParam(v) {
      // 0.05刻み/0.1刻みがあるので小数2桁まで
      return (Math.round(v * 100) / 100).toFixed(2);
    }

    distTypeEl.addEventListener("change", () => {
      state.settings.distType = distTypeEl.value;
      // 切り替え時は現在の値をそのまま流用（範囲外なら丸め）
      state.settings.distParam = parseFloat(distParamEl.value);
      applyDistUIByType(state.settings.distType, state.settings.distParam);
      state.settings.distParam = parseFloat(distParamEl.value);
      saveState();
    });

    distParamEl.addEventListener("input", () => {
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
    });

    distParamEl.addEventListener("change", () => {
      state.settings.distParam = parseFloat(distParamEl.value);
      saveState();
    });

    // ---------- 抽選 ----------
    drawBtn.addEventListener("click", () => {
      const k = clampInt(parseInt(ticketsPerDrawEl.value, 10), 1, 50);
      state.settings.ticketsPerDraw = k;

      const now = new Date();
      const tsISO = now.toISOString();

      const tickets = [];
      for (let t = 0; t < k; t++) {
        const ranks = [];
        for (let r = 0; r < 5; r++) {
          const N = clampInt(state.settings.Ns[r] ?? 10, 1, 18);
          const rank = weightedSampleRank(N, state.settings.distType, state.settings.distParam);
          ranks.push(rank);
        }
        tickets.push({ ranks, tsISO });
      }

      // 四角窓に表示
      state.lastDrawTickets = tickets;
      renderRaceWindowsFromTickets(tickets);

      // ログに1通りずつ追加（チェックは通りごと）
      for (let t = 0; t < tickets.length; t++) {
        const entry = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          tsISO,
          ranks: tickets[t].ranks,
          purchased: false
        };
        state.log.unshift(entry);
      }

      // サイズ制限
      if (state.log.length > MAX_LOG) {
        state.log = state.log.slice(0, MAX_LOG);
      }

      saveState();
      renderLog();
    });

    // ---------- 初期化 ----------
    resetBtn.addEventListener("click", () => {
      const ok = confirm("設定とログをすべて初期化します。よろしいですか？");
      if (!ok) return;
      state = structuredClone(DEFAULT_STATE);
      saveState();
      hydrateUI();
    });

    // ---------- ログ操作 ----------
    clearChecksBtn.addEventListener("click", () => {
      for (const e of state.log) e.purchased = false;
      saveState();
      renderLog();
    });

    deleteCheckedBtn.addEventListener("click", () => {
      const checkedCount = state.log.filter(e => e.purchased).length;
      if (checkedCount === 0) return;
      const ok = confirm(`購入済みにチェックした ${checkedCount} 行を削除します。よろしいですか？`);
      if (!ok) return;
      state.log = state.log.filter(e => !e.purchased);
      saveState();
      renderLog();
      // lastDrawは触らない（直近表示の視認性を優先）
    });

    // ---------- 描画 ----------
    function renderRaceWindowsFromTickets(tickets) {
      if (!tickets || tickets.length === 0) {
        for (let i = 0; i < 5; i++) raceResultEls[i].textContent = "未抽選";
        return;
      }
      for (let r = 0; r < 5; r++) {
        const lines = [];
        for (let t = 0; t < tickets.length; t++) {
          const rank = tickets[t].ranks[r];
          lines.push(`${t + 1}: 人気${rank}`);
        }
        raceResultEls[r].textContent = lines.join("\n");
      }
    }

    function renderLog() {
      logBody.innerHTML = "";
      if (!state.log || state.log.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.className = "muted";
        td.textContent = "ログはまだありません。";
        td.style.padding = "14px 10px";
        tr.appendChild(document.createElement("td")); // 購入
        tr.lastChild.style.display = "none";
        tr.appendChild(td);
        logBody.appendChild(tr);
        return;
      }

      for (const entry of state.log) {
        const tr = document.createElement("tr");

        // 購入チェック
        const tdCheck = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "checkbox";
        cb.checked = !!entry.purchased;
        cb.addEventListener("change", () => {
          entry.purchased = cb.checked;
          saveState();
        });
        tdCheck.appendChild(cb);

        // 日時
        const tdTs = document.createElement("td");
        const tsSpan = document.createElement("div");
        tsSpan.className = "ts";
        tsSpan.textContent = formatTs(entry.tsISO);
        tdTs.appendChild(tsSpan);

        // 組み合わせ
        const tdCombo = document.createElement("td");
        const combo = document.createElement("div");
        combo.className = "combo";
        combo.textContent = formatCombo(entry.ranks);
        tdCombo.appendChild(combo);

        tr.appendChild(tdCheck);
        tr.appendChild(tdTs);
        tr.appendChild(tdCombo);

        logBody.appendChild(tr);
      }
    }

    function formatCombo(ranks) {
      // 例: R1:人気3 / R2:人気1 / ...
      const parts = [];
      for (let i = 0; i < 5; i++) {
        parts.push(`R${i + 1}:人気${ranks[i]}`);
      }
      return parts.join(" / ");
    }

    function formatTs(tsISO) {
      const d = new Date(tsISO);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    // ---------- 抽選ロジック ----------
    function weightedSampleRank(N, distType, distParam) {
      if (N <= 1) return 1;

      const weights = new Array(N);
      if (distType === "power") {
        const s = clampFloat(distParam, 0, 4.0);
        for (let i = 0; i < N; i++) {
          const rank = i + 1;
          weights[i] = 1 / Math.pow(rank, Math.max(0.00001, s));
        }
      } else {
        const lambda = clampFloat(distParam, 0, 2.0);
        for (let i = 0; i < N; i++) {
          weights[i] = Math.exp(-lambda * i);
        }
      }

      let sum = 0;
      for (let i = 0; i < N; i++) sum += weights[i];

      let r = Math.random() * sum;
      for (let i = 0; i < N; i++) {
        r -= weights[i];
        if (r <= 0) return i + 1;
      }
      return N;
    }

    // ---------- localStorage ----------
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        // 必要最低限の整形
        const s = structuredClone(DEFAULT_STATE);
        if (parsed && typeof parsed === "object") {
          if (parsed.settings && typeof parsed.settings === "object") {
            if (Array.isArray(parsed.settings.Ns) && parsed.settings.Ns.length === 5) {
              s.settings.Ns = parsed.settings.Ns.map(v => clampInt(parseInt(v,10), 1, 18));
            }
            s.settings.ticketsPerDraw = clampInt(parseInt(parsed.settings.ticketsPerDraw,10), 1, 50) || 1;
            s.settings.distType = (parsed.settings.distType === "power") ? "power" : "exp";
            s.settings.distParam = Number.isFinite(parsed.settings.distParam) ? parsed.settings.distParam : 0.9;
          }
          if (Array.isArray(parsed.lastDrawTickets)) {
            s.lastDrawTickets = parsed.lastDrawTickets
              .filter(t => t && Array.isArray(t.ranks) && t.ranks.length === 5)
              .map(t => ({
                ranks: t.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                tsISO: (typeof t.tsISO === "string") ? t.tsISO : new Date().toISOString()
              }));
          }
          if (Array.isArray(parsed.log)) {
            s.log = parsed.log
              .filter(e => e && Array.isArray(e.ranks) && e.ranks.length === 5)
              .map(e => ({
                id: (typeof e.id === "string") ? e.id : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                tsISO: (typeof e.tsISO === "string") ? e.tsISO : new Date().toISOString(),
                ranks: e.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                purchased: !!e.purchased
              }))
              .slice(0, MAX_LOG);
          }
        }
        return s;
      } catch {
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch {
        // 保存失敗時は無視（容量不足など）
      }
    }

    // ---------- ユーティリティ ----------
    function clampInt(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, Math.trunc(v)));
    }
    function clampFloat(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, v));
    }

    function hydrateUI() {
      buildRaceCards();

      ticketsPerDrawEl.value = String(state.settings.ticketsPerDraw ?? 1);

      configureDistUIFromState();

      renderRaceWindowsFromTickets(state.lastDrawTickets);
      renderLog();
    }

    // ---------- 起動 ----------
    hydrateUI();
  </script>
</body>
</html>
