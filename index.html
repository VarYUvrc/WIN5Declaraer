<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WIN5 抽選ツール</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%2306c167'/%3E%3Cstop offset='1' stop-color='%230f7a3f'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='96' height='96' rx='22' fill='%23f6fbf7'/%3E%3Cpath fill='url(%23g)' d='M64 20c-8 0-14 6-16 14-9 1-16 8-16 17 0 10 8 18 18 18h5l-4 12h10l4-12h7c9 0 17-7 17-17S82 20 64 20Zm-8 30c-6 0-10-4-10-9s4-9 10-9 10 4 10 9-4 9-10 9Z'/%3E%3Cpath fill='%230f172a' d='M30 72h36v6H30z'/%3E%3C/svg%3E" />
  <style>
    :root{
      --bg:#f6fbf7;
      --panel:#ffffff;
      --panel2:#f2f8f3;
      --text:#0f172a;
      --muted:#6b7280;
      --border:#d7e5db;
      --accent:#1f9d55;
      --accent-strong:#14823f;
      --danger:#e11d48;
      --ok:#16a34a;
      --shadow: 0 18px 40px rgba(15,70,35,.10);
      --radius: 22px;
      --pill: 999px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Avenir Next", "Helvetica Neue", "Hiragino Sans", "Noto Sans JP", sans-serif;
      background:
        radial-gradient(900px 600px at 15% 0%, rgba(31,157,85,.18), transparent 55%),
        radial-gradient(1100px 700px at 85% 10%, rgba(16,185,129,.12), transparent 60%),
        linear-gradient(180deg, #ffffff, #f6fbf7 55%, #eef7f1 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(12px);
      background: rgba(255,255,255,.78);
      border-bottom:1px solid rgba(215,229,219,.7);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px}
    h1{
      margin:0;
      font-size:inherit;
      letter-spacing:.02em;
    }
    .sub{
      font-size:13px; color:var(--muted); font-weight:600;
      white-space:nowrap;
    }

    main{max-width:1100px; margin:0 auto; padding:18px 14px 26px}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.96), rgba(242,248,243,.96));
      border:1px solid rgba(215,229,219,.9);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .hero{
      display:flex;
      align-items:center;
      gap:16px;
      margin:0;
      padding:6px 0;
    }
    .heroMark{
      width:54px;
      height:54px;
      border-radius:18px;
      background: #ffffff;
      border:1px solid rgba(215,229,219,.9);
      box-shadow: 0 12px 24px rgba(22,101,52,.10);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .heroMark svg{
      width:34px;
      height:34px;
    }
    .heroText{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .heroTitle{
      font-size:22px;
      font-weight:700;
    }
    .heroSub{
      font-size:13px;
      color: var(--muted);
      font-weight:600;
    }

    .controls{
      padding:16px 18px;
      display:flex; flex-wrap:wrap; gap:16px;
      align-items:flex-end; justify-content:flex-start;
    }
    .controls .left{display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end}
    .field{
      display:flex; flex-direction:column; gap:6px;
      min-width: 150px;
    }
    label{
      font-size:13px;
      color:var(--muted);
      font-weight:600;
    }
    input[type="number"], select{
      appearance:none;
      border:1px solid rgba(215,229,219,.95);
      background: rgba(255,255,255,.9);
      color:var(--text);
      border-radius: var(--pill);
      padding:12px 14px;
      font-size:16px;
      outline:none;
    }
    input[type="number"]:focus, select:focus{
      border-color: rgba(31,157,85,.9);
      box-shadow: 0 0 0 4px rgba(31,157,85,.18);
    }
    .btn{
      border:none;
      border-radius: var(--pill);
      padding:14px 20px;
      font-size:16px;
      font-weight:700;
      color: white;
      background: linear-gradient(180deg, rgba(31,157,85,1), rgba(20,130,63,1));
      cursor:pointer;
      box-shadow: 0 16px 34px rgba(31,157,85,.22);
      min-width: 160px;
    }
    .btn:active{transform: translateY(1px)}
    .btn.secondary{
      background: rgba(255,255,255,.85);
      border:1px solid rgba(215,229,219,.95);
      color: var(--text);
      box-shadow:none;
      font-weight:650;
    }
    .btn.danger{
      background: rgba(225,29,72,.08);
      border:1px solid rgba(225,29,72,.35);
      color:#be123c;
      box-shadow:none;
      font-weight:650;
    }
    .btn.subtle{
      background: transparent;
      border:1px solid transparent;
      color: var(--muted);
      font-weight:600;
      box-shadow:none;
      min-width:auto;
      padding:10px 14px;
    }
    .btn.subtle:hover{
      color:#374151;
      background: rgba(31,157,85,.08);
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
      margin-top:18px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: 1fr}
    }

    .race{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 220px;
    }
    .race .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .race .title{
      font-size:15px;
      color: #2f3b35;
      font-weight:700;
    }
    .race .result{
      flex:1;
      background: transparent;
      border:none;
      padding:0;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(72px, 1fr));
      gap:10px;
      align-content:start;
      min-height: 110px;
    }
    .race .bottom{
      display:flex; align-items:center; justify-content:flex-start; gap:10px;
    }
    .race .bottom .field{min-width: 120px}
    .inlineField{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .inlineField select{
      min-width:72px;
      text-align:center;
      font-weight:700;
    }
    .inlineSuffix{
      font-size:14px;
      color: var(--muted);
      font-weight:600;
    }
    .ticketCard{
      background: #ffffff;
      border:1px solid rgba(215,229,219,.95);
      border-radius: 18px;
      box-shadow: 0 10px 20px rgba(22,101,52,.08);
      font-size:28px;
      font-weight:700;
      color:#134e2a;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:64px;
    }
    .ticketLabel{
      font-size:12px;
      color: var(--muted);
      font-weight:600;
    }
    .ticketCard.isEmpty{
      color: var(--muted);
      font-size:16px;
      font-weight:600;
      background: rgba(255,255,255,.6);
    }

    .log{
      margin-top:18px;
      padding:18px;
    }
    .logHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logHead h2{
      margin:0;
      font-size:16px;
      letter-spacing:.01em;
    }
    .logHead .hint{
      margin:0;
      font-size:13px;
      color: var(--muted);
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(215,229,219,.95);
      background: #fff;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color: var(--muted);
      font-weight:700;
      padding:10px 10px;
      background: rgba(242,248,243,.95);
      border-bottom:1px solid rgba(215,229,219,.95);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(215,229,219,.6);
      vertical-align: top;
      font-size:13px;
    }
    tfoot td{
      padding:8px 10px 12px;
    }
    tbody tr:last-child td{border-bottom:none}
    .ts{
      color:#64748b;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space:nowrap;
      font-size:12px;
    }
    .combo{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .comboCard{
      display:flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:12px;
      border:1px solid rgba(215,229,219,.9);
      background: rgba(242,248,243,.95);
      font-weight:700;
      color:#134e2a;
      font-size:12px;
    }
    .comboCardLabel{
      font-size:10px;
      color: var(--muted);
      font-weight:600;
    }
    .comboCardValue{
      font-size:13px;
      color:#134e2a;
    }
    .muted{color:var(--muted)}
    .checkbox{
      width:18px; height:18px;
      accent-color: var(--ok);
    }
    .logScroll{
      max-height: 380px;
      overflow:auto;
      border-radius: 14px;
    }

    .weights{
      margin-top:18px;
      padding:18px;
    }
    .weights h2{margin:0 0 10px 0; font-size:16px}
    .weightsGrid{
      display:grid;
      grid-template-columns: 220px 1fr 80px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 720px){
      .weightsGrid{grid-template-columns: 1fr}
    }
    input[type="range"]{
      width:100%;
    }
    .small{
      font-size:12px;
      color: var(--muted);
      margin:10px 0 0 0;
      line-height: 1.6;
    }
    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius: 999px;
      border:1px solid rgba(215,229,219,.95);
      background: rgba(242,248,243,.95);
      color: var(--muted);
      font-size:12px;
      font-weight:650;
    }
    .paramValue{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(215,229,219,.95);
      background: rgba(255,255,255,.9);
      font-family: ui-monospace, monospace;
      font-size:13px;
      color:#0f172a;
    }
    .actionBar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:flex-end;
      gap:14px;
      margin:18px 0 8px;
    }
    .fieldRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .fieldRow label{
      margin:0;
      white-space:nowrap;
    }
    .footerActions{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:18px 0 8px;
    }
    .footerLink{
      color:#0f7a3f;
      font-weight:600;
      text-decoration:none;
      align-self:center;
    }
    .footerLink:hover{
      text-decoration:underline;
    }
    .logFoot{
      display:grid;
      grid-template-columns: 74px 150px 1fr 50px;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .btn.compact{
      min-width:auto;
      padding:8px 12px;
      font-size:13px;
      border-radius:12px;
      box-shadow:none;
    }
    .iconBtn{
      border:none;
      background: transparent;
      color:#6b7280;
      cursor:pointer;
      padding:6px;
      border-radius: 10px;
    }
    .iconBtn:hover{
      background: rgba(225,29,72,.08);
      color:#be123c;
    }
    .iconBtn.danger{
      color:#be123c;
    }
    .iconBtn.danger:hover{
      background: rgba(225,29,72,.12);
    }
    .trashIcon{
      width:16px;
      height:16px;
      display:block;
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="hero">
        <div class="heroMark">
          <svg viewBox="0 0 96 96" aria-hidden="true">
            <defs>
              <linearGradient id="heroG" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#06c167"/>
                <stop offset="1" stop-color="#0f7a3f"/>
              </linearGradient>
            </defs>
            <rect x="6" y="10" width="64" height="50" rx="12" fill="#f6fbf7" stroke="#d7e5db" stroke-width="4"/>
            <path fill="url(#heroG)" d="M68 16c-8 0-14 6-16 14-9 1-16 8-16 17 0 10 8 18 18 18h5l-4 12h10l4-12h7c9 0 17-7 17-17S86 16 68 16Zm-8 30c-6 0-10-4-10-9s4-9 10-9 10 4 10 9-4 9-10 9Z"/>
            <circle cx="82" cy="70" r="12" fill="#facc15" stroke="#eab308" stroke-width="3"/>
            <path d="M78 70h8" stroke="#92400e" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="heroText">
          <h1 class="heroTitle">WIN5 抽選ツール</h1>
          <div class="heroSub">シンプルな抽選と記録</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid" id="racesGrid">
      <!-- JSで生成 -->
    </section>

    <section class="actionBar">
      <div class="fieldRow">
        <label for="ticketsPerDraw">抽選数</label>
        <select id="ticketsPerDraw"></select>
      </div>
      <button id="drawBtn" class="btn">抽選する</button>
      <div aria-hidden="true"></div>
    </section>

    <section class="panel log">
      <div class="logHead">
        <div>
          <h2>これまでの抽選結果</h2>
        </div>
      </div>

      <div class="logScroll">
        <table>
          <thead>
            <tr>
              <th style="width:74px;">購入</th>
              <th style="width:150px;">日時</th>
              <th>組み合わせ</th>
              <th style="width:50px;"></th>
            </tr>
          </thead>
          <tbody id="logBody">
            <!-- JSで描画 -->
          </tbody>
        </table>
      </div>
      <div class="logFoot">
        <div>
          <button id="clearChecksBtn" class="btn secondary compact" title="購入済みチェックをすべて外します">全解除</button>
        </div>
        <div></div>
        <div></div>
        <div style="text-align:right;">
          <button id="deleteCheckedBtn" class="iconBtn danger" title="購入済みにチェックした行を削除します" aria-label="チェック行を全削除">
            <svg class="trashIcon" viewBox="0 0 24 24" aria-hidden="true">
              <path fill="currentColor" d="M9 3h6l1 2h4v2H4V5h4l1-2Zm1 6h2v9h-2V9Zm4 0h2v9h-2V9ZM6 9h2v9H6V9Zm1 12h10a2 2 0 0 0 2-2V7H5v12a2 2 0 0 0 2 2Z"/>
            </svg>
          </button>
        </div>
      </div>
      <p class="small">
        表示は人気番号です。データは端末内に記録されています。馬券購入時は各レースの人気順を参照して、対応する馬番を選択してください。
      </p>

    </section>

    <section class="panel weights">
      <h2>重み設定 <span class="pill">基本触らない想定</span></h2>

      <div class="weightsGrid">
        <div class="field" style="min-width:220px">
          <label for="distType">分布タイプ</label>
          <select id="distType">
            <option value="power">べき乗</option>
          </select>
        </div>

        <div class="field">
          <label id="distParamLabel" for="distParam">偏り（λ）</label>
          <input id="distParam" type="range" />
        </div>

        <div class="field" style="min-width:80px">
          <label>値</label>
          <div id="distParamValue" class="paramValue"></div>
        </div>
      </div>

      <p class="small" id="distHelp"></p>
    </section>

    <section class="footerActions">
      <button id="resetBtn" class="btn subtle" title="設定とログを初期化します">初期化</button>
      <a class="footerLink" href="https://example.com" target="_blank" rel="noopener">勝った一部を作者に寄付する</a>
    </section>
  </main>

  <script>
    "use strict";

    const STORAGE_KEY = "win5_rng_state_v1";
    const MAX_LOG = 800; // localStorage肥大化を避けるため

    const DEFAULT_STATE = {
      version: 1,
      settings: {
        Ns: [10, 10, 10, 10, 10],
        ticketsPerDraw: 1,
        distType: "power",
        distParam: 1.0, // exp: λ, power: s
      },
      lastDrawTickets: [], // [{ranks:[...], tsISO:"..."}]
      log: [] // newest first: [{id, tsISO, ranks:[5], purchased:boolean}]
    };

    let state = loadState();

    // ---------- UI生成 ----------
    const racesGrid = document.getElementById("racesGrid");
    const ticketsPerDrawEl = document.getElementById("ticketsPerDraw");
    const drawBtn = document.getElementById("drawBtn");
    const resetBtn = document.getElementById("resetBtn");

    const logBody = document.getElementById("logBody");
    const clearChecksBtn = document.getElementById("clearChecksBtn");
    const deleteCheckedBtn = document.getElementById("deleteCheckedBtn");

    const distTypeEl = document.getElementById("distType");
    const distParamEl = document.getElementById("distParam");
    const distParamLabelEl = document.getElementById("distParamLabel");
    const distParamValueEl = document.getElementById("distParamValue");
    const distHelpEl = document.getElementById("distHelp");

    const raceResultEls = [];
    const nSelectEls = [];

    function buildTicketsPerDraw() {
      ticketsPerDrawEl.innerHTML = "";
      for (let n = 1; n <= 50; n++) {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = String(n);
        ticketsPerDrawEl.appendChild(opt);
      }
      ticketsPerDrawEl.value = String(state.settings.ticketsPerDraw ?? 1);
      ticketsPerDrawEl.addEventListener("change", () => {
        const v = clampInt(parseInt(ticketsPerDrawEl.value, 10), 1, 50);
        state.settings.ticketsPerDraw = v;
        saveState();
      });
    }

    function buildRaceCards() {
      racesGrid.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const card = document.createElement("section");
        card.className = "panel race";

        const top = document.createElement("div");
        top.className = "top";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = `レース ${i + 1}`;

        top.appendChild(title);

        const result = document.createElement("div");
        result.className = "result";
        result.textContent = "未抽選";
        raceResultEls[i] = result;

        const bottom = document.createElement("div");
        bottom.className = "bottom";

        const inline = document.createElement("div");
        inline.className = "inlineField";
        const sel = document.createElement("select");
        sel.id = `nSelect${i}`;
        sel.setAttribute("aria-label", `レース${i + 1} 上限人気`);
        for (let n = 1; n <= 18; n++) {
          const opt = document.createElement("option");
          opt.value = String(n);
          opt.textContent = String(n);
          sel.appendChild(opt);
        }
        sel.value = String(state.settings.Ns[i] ?? 10);
        sel.addEventListener("change", () => {
          const v = clampInt(parseInt(sel.value, 10), 1, 18);
          state.settings.Ns[i] = v;
          saveState();
        });
        nSelectEls[i] = sel;

        const suffix = document.createElement("span");
        suffix.className = "inlineSuffix";
        suffix.textContent = "番人気まで";

        inline.appendChild(sel);
        inline.appendChild(suffix);

        bottom.appendChild(inline);

        card.appendChild(top);
        card.appendChild(result);
        card.appendChild(bottom);

        racesGrid.appendChild(card);
      }
    }

    // ---------- 分布設定UI ----------
    function configureDistUIFromState() {
      state.settings.distType = "power";
      distTypeEl.value = "power";
      distTypeEl.disabled = true;
      applyDistUIByType("power", state.settings.distParam);
    }

    function applyDistUIByType(type, param) {
      if (type === "exp") {
        distParamLabelEl.textContent = "偏り（λ：指数減衰）";
        distParamEl.min = "0";
        distParamEl.max = "1.2";
        distParamEl.step = "0.05";
        distParamEl.value = String(clampFloat(param, 0, 1.2));
        distHelpEl.textContent = "λを上げるほど、上位人気が選ばれやすくなります。";
      } else {
        distParamLabelEl.textContent = "偏り（s：べき乗）";
        distParamEl.min = "0";
        distParamEl.max = "2.5";
        distParamEl.step = "0.1";
        distParamEl.value = String(clampFloat(param, 0, 2.5));
        distHelpEl.textContent = "sを上げるほど、上位人気が選ばれやすくなります。";
      }
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
    }

    function formatParam(v) {
      // 0.05刻み/0.1刻みがあるので小数2桁まで
      return (Math.round(v * 100) / 100).toFixed(2);
    }

    distTypeEl.addEventListener("change", () => {
      state.settings.distType = "power";
      distTypeEl.value = "power";
      // 切り替え時は現在の値をそのまま流用（範囲外なら丸め）
      state.settings.distParam = parseFloat(distParamEl.value);
      applyDistUIByType("power", state.settings.distParam);
      state.settings.distParam = parseFloat(distParamEl.value);
      saveState();
    });

    distParamEl.addEventListener("input", () => {
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
    });

    distParamEl.addEventListener("change", () => {
      state.settings.distParam = parseFloat(distParamEl.value);
      saveState();
    });

    // ---------- 抽選 ----------
    drawBtn.addEventListener("click", () => {
      const k = clampInt(parseInt(ticketsPerDrawEl.value, 10), 1, 50);
      state.settings.ticketsPerDraw = k;

      const now = new Date();
      const tsISO = now.toISOString();

      const tickets = [];
      for (let t = 0; t < k; t++) {
        const ranks = [];
        for (let r = 0; r < 5; r++) {
          const N = clampInt(state.settings.Ns[r] ?? 10, 1, 18);
          const rank = weightedSampleRank(N, state.settings.distType, state.settings.distParam);
          ranks.push(rank);
        }
        tickets.push({ ranks, tsISO });
      }

      // 四角窓に表示
      state.lastDrawTickets = tickets;
      renderRaceWindowsFromTickets(tickets);

      // ログに1通りずつ追加（チェックは通りごと）
      for (let t = 0; t < tickets.length; t++) {
        const entry = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          tsISO,
          ranks: tickets[t].ranks,
          purchased: false
        };
        state.log.unshift(entry);
      }

      // サイズ制限
      if (state.log.length > MAX_LOG) {
        state.log = state.log.slice(0, MAX_LOG);
      }

      saveState();
      renderLog();
    });

    // ---------- 初期化 ----------
    resetBtn.addEventListener("click", () => {
      const ok = confirm("設定とログをすべて初期化します。よろしいですか？");
      if (!ok) return;
      state = structuredClone(DEFAULT_STATE);
      saveState();
      hydrateUI();
    });

    // ---------- ログ操作 ----------
    clearChecksBtn.addEventListener("click", () => {
      for (const e of state.log) e.purchased = false;
      saveState();
      renderLog();
    });

    deleteCheckedBtn.addEventListener("click", () => {
      const checkedCount = state.log.filter(e => e.purchased).length;
      if (checkedCount === 0) return;
      const ok = confirm(`購入済みにチェックした ${checkedCount} 行を削除します。よろしいですか？`);
      if (!ok) return;
      state.log = state.log.filter(e => !e.purchased);
      saveState();
      renderLog();
      // lastDrawは触らない（直近表示の視認性を優先）
    });

    // ---------- 描画 ----------
    function renderRaceWindowsFromTickets(tickets) {
      if (!tickets || tickets.length === 0) {
        for (let i = 0; i < 5; i++) {
          raceResultEls[i].innerHTML = "";
          const empty = document.createElement("div");
          empty.className = "ticketCard isEmpty";
          empty.textContent = "未抽選";
          raceResultEls[i].appendChild(empty);
        }
        return;
      }
      for (let r = 0; r < 5; r++) {
        raceResultEls[r].innerHTML = "";
        for (let t = 0; t < tickets.length; t++) {
          const rank = tickets[t].ranks[r];
          const card = document.createElement("div");
          card.className = "ticketCard";
          const value = document.createElement("span");
          value.textContent = String(rank);
          const label = document.createElement("span");
          label.className = "ticketLabel";
          label.textContent = "人気";
          card.appendChild(value);
          card.appendChild(label);
          raceResultEls[r].appendChild(card);
        }
      }
    }

    function renderLog() {
      logBody.innerHTML = "";
      if (!state.log || state.log.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.className = "muted";
        td.textContent = "ログはまだありません。";
        td.style.padding = "14px 10px";
        tr.appendChild(td);
        logBody.appendChild(tr);
        return;
      }

      for (const entry of state.log) {
        const tr = document.createElement("tr");

        // 購入チェック
        const tdCheck = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "checkbox";
        cb.checked = !!entry.purchased;
        cb.addEventListener("change", () => {
          entry.purchased = cb.checked;
          saveState();
        });
        tdCheck.appendChild(cb);

        // 日時
        const tdTs = document.createElement("td");
        const tsSpan = document.createElement("div");
        tsSpan.className = "ts";
        tsSpan.textContent = formatTs(entry.tsISO);
        tdTs.appendChild(tsSpan);

        // 組み合わせ
        const tdCombo = document.createElement("td");
        const combo = document.createElement("div");
        combo.className = "combo";
        for (let i = 0; i < 5; i++) {
          const card = document.createElement("div");
          card.className = "comboCard";

          const label = document.createElement("span");
          label.className = "comboCardLabel";
          label.textContent = `R${i + 1}`;

          const value = document.createElement("span");
          value.className = "comboCardValue";
          value.textContent = String(entry.ranks[i]);

          card.appendChild(label);
          card.appendChild(value);
          combo.appendChild(card);
        }
        tdCombo.appendChild(combo);

        const tdDelete = document.createElement("td");
        tdDelete.style.textAlign = "center";
        const delBtn = document.createElement("button");
        delBtn.className = "iconBtn";
        delBtn.title = "この行を削除";
        delBtn.innerHTML = "<svg class='trashIcon' viewBox='0 0 24 24' aria-hidden='true'><path fill='currentColor' d='M9 3h6l1 2h4v2H4V5h4l1-2Zm1 6h2v9h-2V9Zm4 0h2v9h-2V9ZM6 9h2v9H6V9Zm1 12h10a2 2 0 0 0 2-2V7H5v12a2 2 0 0 0 2 2Z'/></svg>";
        delBtn.addEventListener("click", () => {
          state.log = state.log.filter(e => e.id !== entry.id);
          saveState();
          renderLog();
        });
        tdDelete.appendChild(delBtn);

        tr.appendChild(tdCheck);
        tr.appendChild(tdTs);
        tr.appendChild(tdCombo);
        tr.appendChild(tdDelete);

        logBody.appendChild(tr);
      }
    }


    function formatTs(tsISO) {
      const d = new Date(tsISO);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    // ---------- 抽選ロジック ----------
    function weightedSampleRank(N, distType, distParam) {
      if (N <= 1) return 1;

      const weights = new Array(N);
      if (distType === "power") {
        const s = clampFloat(distParam, 0, 2.5);
        for (let i = 0; i < N; i++) {
          const rank = i + 1;
          weights[i] = 1 / Math.pow(rank, Math.max(0.00001, s));
        }
      } else {
        const lambda = clampFloat(distParam, 0, 1.2);
        for (let i = 0; i < N; i++) {
          weights[i] = Math.exp(-lambda * i);
        }
      }

      let sum = 0;
      for (let i = 0; i < N; i++) sum += weights[i];

      let r = Math.random() * sum;
      for (let i = 0; i < N; i++) {
        r -= weights[i];
        if (r <= 0) return i + 1;
      }
      return N;
    }

    // ---------- localStorage ----------
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        // 必要最低限の整形
        const s = structuredClone(DEFAULT_STATE);
        if (parsed && typeof parsed === "object") {
          if (parsed.settings && typeof parsed.settings === "object") {
            if (Array.isArray(parsed.settings.Ns) && parsed.settings.Ns.length === 5) {
              s.settings.Ns = parsed.settings.Ns.map(v => clampInt(parseInt(v,10), 1, 18));
            }
            s.settings.ticketsPerDraw = clampInt(parseInt(parsed.settings.ticketsPerDraw,10), 1, 50) || 1;
            s.settings.distType = "power";
            s.settings.distParam = Number.isFinite(parsed.settings.distParam) ? parsed.settings.distParam : 1.0;
          }
          if (Array.isArray(parsed.lastDrawTickets)) {
            s.lastDrawTickets = parsed.lastDrawTickets
              .filter(t => t && Array.isArray(t.ranks) && t.ranks.length === 5)
              .map(t => ({
                ranks: t.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                tsISO: (typeof t.tsISO === "string") ? t.tsISO : new Date().toISOString()
              }));
          }
          if (Array.isArray(parsed.log)) {
            s.log = parsed.log
              .filter(e => e && Array.isArray(e.ranks) && e.ranks.length === 5)
              .map(e => ({
                id: (typeof e.id === "string") ? e.id : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                tsISO: (typeof e.tsISO === "string") ? e.tsISO : new Date().toISOString(),
                ranks: e.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                purchased: !!e.purchased
              }))
              .slice(0, MAX_LOG);
          }
        }
        return s;
      } catch {
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch {
        // 保存失敗時は無視（容量不足など）
      }
    }

    // ---------- ユーティリティ ----------
    function clampInt(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, Math.trunc(v)));
    }
    function clampFloat(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, v));
    }

    function hydrateUI() {
      buildTicketsPerDraw();
      buildRaceCards();

      configureDistUIFromState();

      renderRaceWindowsFromTickets(state.lastDrawTickets);
      renderLog();
    }

    // ---------- 起動 ----------
    hydrateUI();
  </script>
</body>
</html>
