<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>WIN5 抽選ツール</title>
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 96 96'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1' y1='0' y2='1'%3E%3Cstop offset='0' stop-color='%2306c167'/%3E%3Cstop offset='1' stop-color='%230f7a3f'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='96' height='96' rx='22' fill='%23f6fbf7'/%3E%3Cpath fill='url(%23g)' d='M64 20c-8 0-14 6-16 14-9 1-16 8-16 17 0 10 8 18 18 18h5l-4 12h10l4-12h7c9 0 17-7 17-17S82 20 64 20Zm-8 30c-6 0-10-4-10-9s4-9 10-9 10 4 10 9-4 9-10 9Z'/%3E%3Cpath fill='%230f172a' d='M30 72h36v6H30z'/%3E%3C/svg%3E" />
  <style>
    :root{
      /* Base */
      --bg0:#f7fbf8;
      --bg1:#f3faf6;
      --text:#0f172a;
      --muted:#6b7280;

      /* Glass / Borders */
      --glass: rgba(255,255,255,.68);
      --glass-strong: rgba(255,255,255,.82);
      --border: rgba(206,223,214,.70);

      /* Brand */
      --brand:#0f7a3f;
      --brand-strong:#0b6332;

      /* Accent (use sparingly) */
      --accent:#f97316;          /* orange */
      --accent-strong:#ea580c;   /* deeper orange */
      --accent-soft: rgba(249,115,22,.16);

      /* Controls */
      --field-bg: rgba(245,250,247,.78);
      --danger:#e11d48;
      --ok:#16a34a;

      --shadow: 0 24px 60px rgba(15,23,42,.10), 0 10px 28px rgba(15,23,42,.06);
      --shadow-soft: 0 14px 30px rgba(15,23,42,.08), 0 6px 14px rgba(15,23,42,.05);
      --radius: 22px;
      --pill: 999px;

      --focus: 0 0 0 4px rgba(249,115,22,.18);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Avenir Next", "Helvetica Neue", "Hiragino Sans", "Noto Sans JP", system-ui, -apple-system, sans-serif;
      background:
        radial-gradient(900px 650px at 12% 0%, rgba(15,122,63,.16), transparent 56%),
        radial-gradient(900px 650px at 88% 12%, rgba(249,115,22,.10), transparent 60%),
        linear-gradient(180deg, #ffffff 0%, var(--bg0) 48%, var(--bg1) 100%);
      color:var(--text);
    }

    header{
      position:sticky; top:0; z-index:5;
      backdrop-filter: blur(14px) saturate(160%);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
      background: rgba(255,255,255,.62);
      border-bottom:1px solid var(--border);
    }

    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px}
    main{max-width:1100px; margin:0 auto; padding:18px 14px 26px}

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.74), rgba(255,255,255,.60));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px) saturate(160%);
      -webkit-backdrop-filter: blur(14px) saturate(160%);
    }

    /* Header */
    .hero{
      display:flex;
      align-items:center;
      gap:16px;
      margin:0;
      padding:6px 0;
    }
    .heroMark{
      width:54px;
      height:54px;
      border-radius:18px;
      background: rgba(255,255,255,.82);
      border:1px solid var(--border);
      box-shadow: 0 14px 26px rgba(15,23,42,.08);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .heroMark svg{width:34px;height:34px}
    .heroText{display:flex; flex-direction:column; gap:4px}
    .heroTitle{font-size:22px;font-weight:750; letter-spacing:.01em; margin:0}
    .heroSub{font-size:13px; color: var(--muted); font-weight:600}

    /* Grid */
    .grid{
      display:grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap:14px;
      margin-top:18px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr))}
    }
    @media (max-width: 520px){
      .grid{grid-template-columns: 1fr}
    }

    /* Race cards */
    .race{
      padding:16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      min-height: 220px;
    }
    .race .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .race .title{
      font-size:15px;
      color: rgba(15,23,42,.86);
      font-weight:760;
    }
    .race .result{
      flex:1;
      padding:0;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-content:start;
      min-height: 110px;
    }
    .race .bottom{
      display:flex; align-items:center; justify-content:flex-start; gap:10px;
    }
    .inlineField{
      display:flex;
      align-items:center;
      gap:8px;
    }

    label{
      font-size:13px;
      color:var(--muted);
      font-weight:650;
    }
    input[type="number"], select{
      appearance:none;
      border:1px solid rgba(206,223,214,.85);
      background: var(--field-bg);
      color:var(--text);
      border-radius: var(--pill);
      padding:12px 14px;
      font-size:16px;
      outline:none;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.35);
    }
    input[type="number"]:focus, select:focus{
      border-color: rgba(249,115,22,.75);
      box-shadow: var(--focus);
    }

    .inlineField select{
      min-width:72px;
      text-align:center;
      font-weight:780;
    }
    .inlineSuffix{
      font-size:14px;
      color: var(--muted);
      font-weight:650;
    }

    .ticketCard{
      background: rgba(255,255,255,.80);
      border:1px solid rgba(206,223,214,.78);
      border-radius: 18px;
      box-shadow: var(--shadow-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      min-height:64px;
      position:relative;
      overflow:hidden;
    }
    .ticketCard::before{
      content:"";
      position:absolute;
      inset:-40% -40% auto -40%;
      height:120%;
      background: radial-gradient(closest-side, rgba(15,122,63,.10), transparent 65%);
      pointer-events:none;
    }
    .ticketCard > *{position:relative}
    .ticketNum{
      font-size:30px;
      font-weight:820;
      letter-spacing:.01em;
      color: rgba(15,23,42,.92);
    }
    .ticketLabel{
      font-size:12px;
      color: rgba(107,114,128,.95);
      font-weight:650;
    }
    .ticketCard.isEmpty{
      background: rgba(255,255,255,.56);
      color: var(--muted);
      box-shadow: none;
      justify-content:center;
      font-weight:650;
    }
    .ticketEmptyText{font-size:16px}

    /* Action bar: button always centered */
    .actionBar{
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      column-gap: 14px;
      margin:18px 0 8px;
    }
    .actionLeft{
      justify-self:end;
    }
    .actionCenter{
      justify-self:center;
    }
    .actionRight{
      justify-self:start;
      min-height: 1px; /* keep column */
    }
    @media (max-width: 520px){
      .actionBar{
        grid-template-columns: 1fr;
        row-gap: 10px;
      }
      .actionLeft, .actionCenter, .actionRight{
        justify-self:center;
      }
      .actionRight{display:none;}
    }

    .fieldRow{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .fieldRow label{
      margin:0;
      white-space:nowrap;
    }
    .fieldRow select{
      text-align:center;
      min-width:56px;
      padding:10px 12px;
      font-weight:780;
    }

    .btn{
      border:none;
      border-radius: var(--pill);
      padding:14px 22px;
      font-size:16px;
      font-weight:820;
      color: white;
      cursor:pointer;
      min-width: 180px;

      /* Accent as the star */
      background: linear-gradient(180deg, rgba(249,115,22,1), rgba(234,88,12,1));
      box-shadow: 0 18px 40px rgba(249,115,22,.24), 0 8px 20px rgba(15,23,42,.08);
      position:relative;
      isolation:isolate;
    }
    .btn::after{
      content:"";
      position:absolute;
      inset:-2px;
      border-radius: inherit;
      background: radial-gradient(60% 120% at 50% 0%, rgba(255,255,255,.55), transparent 55%);
      mix-blend-mode: overlay;
      opacity:.55;
      pointer-events:none;
      z-index:-1;
    }
    .btn:active{transform: translateY(1px)}

    .btn.secondary{
      background: rgba(255,255,255,.58);
      border:1px solid var(--border);
      color: rgba(15,23,42,.82);
      box-shadow:none;
      font-weight:700;
      min-width:auto;
      padding:10px 14px;
    }
    .btn.subtle{
      background: transparent;
      border:1px solid transparent;
      color: var(--muted);
      font-weight:650;
      box-shadow:none;
      min-width:auto;
      padding:10px 14px;
    }
    .btn.subtle:hover{
      color: rgba(15,23,42,.82);
      background: rgba(249,115,22,.10);
    }

    /* Log */
    .log{
      margin-top:18px;
      padding:18px;
    }
    .logHead{
      display:flex; align-items:flex-end; justify-content:space-between; gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .logHead h2{margin:0; font-size:16px; letter-spacing:.01em}
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(206,223,214,.85);
      background: rgba(255,255,255,.72);
      table-layout: fixed;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color: rgba(107,114,128,.95);
      font-weight:800;
      padding:10px 10px;
      background: rgba(255,255,255,.68);
      border-bottom:1px solid rgba(206,223,214,.75);
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(206,223,214,.55);
      vertical-align: top;
      font-size:13px;
    }
    tbody tr{
      background: rgba(255,255,255,.55);
    }
    tbody tr:nth-child(even){
      background: rgba(245,250,247,.72);
    }
    tbody tr:last-child td{border-bottom:none}

    .logScroll{
      max-height: 380px;
      overflow:auto;
      border-radius: 14px;
    }

    .ts{
      color:#64748b;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      white-space:nowrap;
      font-size:12px;
    }
    .combo{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .comboCard{
      display:flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border-radius:12px;
      border:1px solid rgba(206,223,214,.85);
      background: rgba(255,255,255,.78);
      font-weight:800;
      color: rgba(15,23,42,.88);
      font-size:12px;
      flex:1 1 76px;
    }
    .comboCardLabel{
      font-size:10px;
      color: rgba(107,114,128,.95);
      font-weight:700;
    }
    .comboCardValue{
      font-size:13px;
      color: rgba(15,23,42,.90);
      min-width:20px;
      text-align:center;
      flex:1;
    }

    .checkbox{
      width:18px; height:18px;
      accent-color: var(--brand);
    }

    .logDeleteHead,
    .logDeleteCell{
      width:44px;
      text-align:center;
    }
    .tsCell{vertical-align: middle;}
    .hitCell{
      text-align:left;
      vertical-align: middle;
      padding-left:10px;
    }

    .hitCheck{
      appearance:none;
      width:18px;
      height:18px;
      border-radius:50%;
      border:1px solid rgba(15,122,63,.25);
      background: radial-gradient(circle at 35% 35%, rgba(15,122,63,.10), rgba(15,122,63,.02));
      cursor:pointer;
      display:block;
      margin:0;
    }
    .hitCheck:checked{
      background: var(--ok);
      border-color: #15803d;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.82);
    }

    .iconBtn{
      border:none;
      background: transparent;
      color:#6b7280;
      cursor:pointer;
      padding:6px;
      border-radius: 10px;
    }
    .iconBtn:hover{
      background: rgba(225,29,72,.08);
      color:#be123c;
    }
    .trashIcon{width:16px;height:16px;display:block}

    .logFoot{
      display:grid;
      grid-template-columns: 74px 1fr;
      align-items:center;
      gap:10px;
      margin-top:10px;
    }
    .logNote{
      font-size:12px;
      color: rgba(107,114,128,.95);
      line-height:1.5;
    }

    /* Weights */
    .weights{
      margin-top:18px;
      padding:0;
    }
    .weightsSummary{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:16px 18px;
      cursor:pointer;
      list-style:none;
      font-size:16px;
      font-weight:820;
    }
    .weightsSummary::-webkit-details-marker{display:none}
    .weightsBody{padding:0 18px 18px}
    .weightsGrid{
      display:grid;
      grid-template-columns: 220px 1fr 90px;
      gap:10px;
      align-items:center;
    }
    @media (max-width: 720px){
      .weightsGrid{grid-template-columns: 1fr}
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius: 999px;
      border:1px solid rgba(249,115,22,.22);
      background: rgba(249,115,22,.10);
      color: rgba(124,45,18,.90);
      font-size:12px;
      font-weight:800;
    }

    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
      background: linear-gradient(90deg,
        rgba(249,115,22,.90) 0%,
        rgba(249,115,22,.90) var(--range-fill, 50%),
        rgba(226,232,240,.90) var(--range-fill, 50%),
        rgba(226,232,240,.90) 100%);
      border-radius: 999px;
      height:6px;
      -webkit-appearance:none;
    }
    input[type="range"]::-webkit-slider-thumb{
      -webkit-appearance:none;
      width:18px;
      height:18px;
      border-radius:50%;
      background: var(--accent);
      border:2px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 20px rgba(249,115,22,.28);
    }
    input[type="range"]::-moz-range-track{
      background: linear-gradient(90deg,
        rgba(249,115,22,.90) 0%,
        rgba(249,115,22,.90) var(--range-fill, 50%),
        rgba(226,232,240,.90) var(--range-fill, 50%),
        rgba(226,232,240,.90) 100%);
      border-radius:999px;
      height:6px;
    }
    input[type="range"]::-moz-range-thumb{
      width:18px;
      height:18px;
      border-radius:50%;
      background: var(--accent);
      border:2px solid rgba(255,255,255,.92);
      box-shadow: 0 10px 20px rgba(249,115,22,.28);
    }

    .formulaBox{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(206,223,214,.85);
      background: rgba(245,250,247,.70);
      font-family: ui-monospace, monospace;
      font-size:13px;
      color:#0f172a;
    }
    .paramValue{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(206,223,214,.85);
      background: rgba(245,250,247,.70);
      font-family: ui-monospace, monospace;
      font-size:13px;
      color:#0f172a;
    }
    .small{
      font-size:12px;
      color: rgba(107,114,128,.95);
      margin:10px 0 0 0;
      line-height: 1.6;
    }

    /* Footer */
    .footerActions{
      display:flex;
      justify-content:center;
      gap:16px;
      margin:18px 0 8px;
    }
    .footerLink{
      color: var(--brand);
      font-weight:700;
      text-decoration:none;
      align-self:center;
    }
    .footerLink:hover{ text-decoration:underline; }

    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="hero">
        <div class="heroMark">
          <svg viewBox="0 0 96 96" aria-hidden="true">
            <defs>
              <linearGradient id="heroG" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0" stop-color="#06c167"/>
                <stop offset="1" stop-color="#0f7a3f"/>
              </linearGradient>
            </defs>
            <rect x="6" y="10" width="64" height="50" rx="12" fill="#f6fbf7" stroke="#d7e5db" stroke-width="4"/>
            <path fill="url(#heroG)" d="M68 16c-8 0-14 6-16 14-9 1-16 8-16 17 0 10 8 18 18 18h5l-4 12h10l4-12h7c9 0 17-7 17-17S86 16 68 16Zm-8 30c-6 0-10-4-10-9s4-9 10-9 10 4 10 9-4 9-10 9Z"/>
            <circle cx="82" cy="70" r="12" fill="#facc15" stroke="#eab308" stroke-width="3"/>
            <path d="M78 70h8" stroke="#92400e" stroke-width="3" stroke-linecap="round"/>
          </svg>
        </div>
        <div class="heroText">
          <h1 class="heroTitle">WIN5 抽選ツール</h1>
          <div class="heroSub">シンプルな抽選と記録</div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section class="grid" id="racesGrid">
      <!-- JSで生成 -->
    </section>

    <!-- Button always centered -->
    <section class="actionBar" aria-label="抽選アクション">
      <div class="actionLeft">
        <div class="fieldRow">
          <label for="ticketsPerDraw">抽選数</label>
          <select id="ticketsPerDraw"></select>
        </div>
      </div>

      <div class="actionCenter">
        <button id="drawBtn" class="btn">投票する！</button>
      </div>

      <div class="actionRight"></div>
    </section>

    <section class="panel log">
      <div class="logHead">
        <div>
          <h2>あなたのこれまでの抽選結果</h2>
        </div>
      </div>

      <div class="logScroll">
        <table>
          <colgroup>
            <col style="width:74px;">
            <col style="width:150px;">
            <col>
            <col style="width:64px;">
            <col style="width:44px;">
          </colgroup>
          <thead>
            <tr>
              <th>購入</th>
              <th>日時</th>
              <th>組み合わせ</th>
              <th>的中</th>
              <th class="logDeleteHead"></th>
            </tr>
          </thead>
          <tbody id="logBody">
            <!-- JSで描画 -->
          </tbody>
        </table>
      </div>
      <div class="logFoot">
        <div>
          <button id="clearChecksBtn" class="btn secondary" title="購入済みチェックをすべて外します">全解除</button>
        </div>
        <div class="logNote">
          表示は人気番号です。データは端末内に記録されています。馬券購入時は各レースの人気順を参照して、対応する馬番を選択してください。
        </div>
      </div>
    </section>

    <details class="panel weights">
      <summary class="weightsSummary">抽選の重み設定 <span class="pill">おすすめ設定</span></summary>
      <div class="weightsBody">
        <div class="weightsGrid">
          <div class="field" style="min-width:220px">
            <label>計算式</label>
            <div class="formulaBox">weight(i) = 1 / i^s</div>
          </div>

          <div class="field">
            <label id="distParamLabel" for="distParam">偏り（s）</label>
            <input id="distParam" type="range" />
          </div>

          <div class="field" style="min-width:90px">
            <label>値</label>
            <div id="distParamValue" class="paramValue"></div>
          </div>
        </div>

        <p class="small" id="distHelp"></p>
      </div>
    </details>

    <section class="footerActions">
      <button id="resetBtn" class="btn subtle" title="設定とログを初期化します">初期化</button>
      <a class="footerLink" href="https://github.com/sponsors/VarYUvrc" target="_blank" rel="noopener">勝った一部を作者に寄付する</a>
    </section>
  </main>

  <script>
    "use strict";

    const STORAGE_KEY = "win5_rng_state_v1";
    const MAX_LOG = 800; // localStorage肥大化を避けるため

    const DEFAULT_STATE = {
      version: 1,
      settings: {
        Ns: [10, 10, 10, 10, 10],
        ticketsPerDraw: 1,
        distType: "power",
        distParam: 1.0,
      },
      lastDrawTickets: [],
      log: [] // newest first: [{id, tsISO, ranks:[...], purchased:boolean, hit:boolean}]
    };

    let state = loadState();

    // ---------- UI生成 ----------
    const racesGrid = document.getElementById("racesGrid");
    const ticketsPerDrawEl = document.getElementById("ticketsPerDraw");
    const drawBtn = document.getElementById("drawBtn");
    const resetBtn = document.getElementById("resetBtn");

    const logBody = document.getElementById("logBody");
    const clearChecksBtn = document.getElementById("clearChecksBtn");

    const distParamEl = document.getElementById("distParam");
    const distParamLabelEl = document.getElementById("distParamLabel");
    const distParamValueEl = document.getElementById("distParamValue");
    const distHelpEl = document.getElementById("distHelp");

    const raceResultEls = [];
    const nSelectEls = [];

    function buildTicketsPerDraw() {
      ticketsPerDrawEl.innerHTML = "";
      for (let n = 1; n <= 50; n++) {
        const opt = document.createElement("option");
        opt.value = String(n);
        opt.textContent = String(n);
        ticketsPerDrawEl.appendChild(opt);
      }
      ticketsPerDrawEl.value = String(state.settings.ticketsPerDraw ?? 1);
      ticketsPerDrawEl.addEventListener("change", () => {
        const v = clampInt(parseInt(ticketsPerDrawEl.value, 10), 1, 50);
        state.settings.ticketsPerDraw = v;
        saveState();
      });
    }

    function buildRaceCards() {
      racesGrid.innerHTML = "";
      for (let i = 0; i < 5; i++) {
        const card = document.createElement("section");
        card.className = "panel race";

        const top = document.createElement("div");
        top.className = "top";

        const title = document.createElement("div");
        title.className = "title";
        title.textContent = `レース ${i + 1}`;

        top.appendChild(title);

        const result = document.createElement("div");
        result.className = "result";
        result.textContent = "未抽選";
        raceResultEls[i] = result;

        const bottom = document.createElement("div");
        bottom.className = "bottom";

        const inline = document.createElement("div");
        inline.className = "inlineField";

        const sel = document.createElement("select");
        sel.id = `nSelect${i}`;
        sel.setAttribute("aria-label", `レース${i + 1} 上限人気`);
        for (let n = 1; n <= 18; n++) {
          const opt = document.createElement("option");
          opt.value = String(n);
          opt.textContent = String(n);
          sel.appendChild(opt);
        }
        sel.value = String(state.settings.Ns[i] ?? 10);
        sel.addEventListener("change", () => {
          const v = clampInt(parseInt(sel.value, 10), 1, 18);
          state.settings.Ns[i] = v;
          saveState();
        });
        nSelectEls[i] = sel;

        const suffix = document.createElement("span");
        suffix.className = "inlineSuffix";
        suffix.textContent = "番人気まで";

        inline.appendChild(sel);
        inline.appendChild(suffix);

        bottom.appendChild(inline);

        card.appendChild(top);
        card.appendChild(result);
        card.appendChild(bottom);

        racesGrid.appendChild(card);
      }
    }

    // ---------- 分布設定UI ----------
    function configureDistUIFromState() {
      state.settings.distType = "power";
      applyDistUIByType("power", state.settings.distParam);
      updateRangeFill();
    }

    function applyDistUIByType(type, param) {
      distParamLabelEl.textContent = "偏り（s）";
      distParamEl.min = "0";
      distParamEl.max = "2.5";
      distParamEl.step = "0.1";
      distParamEl.value = String(clampFloat(param, 0, 2.5));
      distHelpEl.textContent = "sを上げるほど、上位人気が選ばれやすくなります。";
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
      updateRangeFill();
    }

    function formatParam(v) {
      return (Math.round(v * 100) / 100).toFixed(2);
    }

    function updateRangeFill() {
      const min = parseFloat(distParamEl.min);
      const max = parseFloat(distParamEl.max);
      const value = parseFloat(distParamEl.value);
      const percent = ((value - min) / (max - min)) * 100;
      distParamEl.style.setProperty("--range-fill", `${percent}%`);
    }

    distParamEl.addEventListener("input", () => {
      distParamValueEl.textContent = formatParam(parseFloat(distParamEl.value));
      updateRangeFill();
    });

    distParamEl.addEventListener("change", () => {
      state.settings.distParam = parseFloat(distParamEl.value);
      updateRangeFill();
      saveState();
    });

    // ---------- 抽選 ----------
    drawBtn.addEventListener("click", () => {
      const k = clampInt(parseInt(ticketsPerDrawEl.value, 10), 1, 50);
      state.settings.ticketsPerDraw = k;

      const now = new Date();
      const tsISO = now.toISOString();

      const tickets = [];
      for (let t = 0; t < k; t++) {
        const ranks = [];
        for (let r = 0; r < 5; r++) {
          const N = clampInt(state.settings.Ns[r] ?? 10, 1, 18);
          const rank = weightedSampleRank(N, state.settings.distType, state.settings.distParam);
          ranks.push(rank);
        }
        tickets.push({ ranks, tsISO });
      }

      const sortedTickets = sortTicketsByRanks(tickets);

      state.lastDrawTickets = sortedTickets;
      renderRaceWindowsFromTickets(sortedTickets);

      for (let t = 0; t < sortedTickets.length; t++) {
        const entry = {
          id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
          tsISO,
          ranks: sortedTickets[t].ranks,
          purchased: false,
          hit: false
        };
        state.log.unshift(entry);
      }

      if (state.log.length > MAX_LOG) {
        state.log = state.log.slice(0, MAX_LOG);
      }

      saveState();
      renderLog();
    });

    // ---------- 初期化 ----------
    resetBtn.addEventListener("click", () => {
      const ok = confirm("設定とログをすべて初期化します。よろしいですか？");
      if (!ok) return;
      state = structuredClone(DEFAULT_STATE);
      saveState();
      hydrateUI();
    });

    // ---------- ログ操作 ----------
    clearChecksBtn.addEventListener("click", () => {
      for (const e of state.log) e.purchased = false;
      saveState();
      renderLog();
    });

    // ---------- 描画 ----------
    function renderRaceWindowsFromTickets(tickets) {
      if (!tickets || tickets.length === 0) {
        for (let i = 0; i < 5; i++) {
          raceResultEls[i].innerHTML = "";
          const empty = document.createElement("div");
          empty.className = "ticketCard isEmpty";
          const txt = document.createElement("span");
          txt.className = "ticketEmptyText";
          txt.textContent = "未抽選";
          empty.appendChild(txt);
          raceResultEls[i].appendChild(empty);
        }
        return;
      }
      for (let r = 0; r < 5; r++) {
        raceResultEls[r].innerHTML = "";
        for (let t = 0; t < tickets.length; t++) {
          const rank = tickets[t].ranks[r];
          const card = document.createElement("div");
          card.className = "ticketCard";

          const value = document.createElement("span");
          value.className = "ticketNum";
          value.textContent = String(rank);

          const label = document.createElement("span");
          label.className = "ticketLabel";
          label.textContent = "人気";

          card.appendChild(value);
          card.appendChild(label);
          raceResultEls[r].appendChild(card);
        }
      }
    }

    function renderLog() {
      logBody.innerHTML = "";
      if (!state.log || state.log.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.className = "muted";
        td.textContent = "ログはまだありません。";
        td.style.padding = "14px 10px";
        tr.appendChild(td);
        logBody.appendChild(tr);
        return;
      }

      for (const entry of state.log) {
        const tr = document.createElement("tr");

        // 購入チェック
        const tdCheck = document.createElement("td");
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "checkbox";
        cb.checked = !!entry.purchased;
        cb.addEventListener("change", () => {
          entry.purchased = cb.checked;
          saveState();
        });
        tdCheck.appendChild(cb);

        // 日時
        const tdTs = document.createElement("td");
        tdTs.className = "tsCell";
        const tsSpan = document.createElement("div");
        tsSpan.className = "ts";
        tsSpan.textContent = formatTs(entry.tsISO);
        tdTs.appendChild(tsSpan);

        // 組み合わせ
        const tdCombo = document.createElement("td");
        const combo = document.createElement("div");
        combo.className = "combo";
        for (let i = 0; i < 5; i++) {
          const card = document.createElement("div");
          card.className = "comboCard";

          const label = document.createElement("span");
          label.className = "comboCardLabel";
          label.textContent = `R${i + 1}`;

          const value = document.createElement("span");
          value.className = "comboCardValue";
          value.textContent = String(entry.ranks[i]);

          card.appendChild(label);
          card.appendChild(value);
          combo.appendChild(card);
        }
        tdCombo.appendChild(combo);

        // 的中
        const tdHit = document.createElement("td");
        tdHit.className = "hitCell";
        const hit = document.createElement("input");
        hit.type = "checkbox";
        hit.className = "hitCheck";
        hit.checked = !!entry.hit;
        hit.addEventListener("change", () => {
          entry.hit = hit.checked;
          saveState();
        });
        tdHit.appendChild(hit);

        // 削除
        const tdDelete = document.createElement("td");
        tdDelete.className = "logDeleteCell";
        const delBtn = document.createElement("button");
        delBtn.className = "iconBtn";
        delBtn.title = "この行を削除";
        delBtn.innerHTML = "<svg class='trashIcon' viewBox='0 0 24 24' aria-hidden='true'><path fill='currentColor' d='M9 3h6l1 2h4v2H4V5h4l1-2Zm1 6h2v9h-2V9Zm4 0h2v9h-2V9ZM6 9h2v9H6V9Zm1 12h10a2 2 0 0 0 2-2V7H5v12a2 2 0 0 0 2 2Z'/></svg>";
        delBtn.addEventListener("click", () => {
          state.log = state.log.filter(e => e.id !== entry.id);
          saveState();
          renderLog();
        });
        tdDelete.appendChild(delBtn);

        tr.appendChild(tdCheck);
        tr.appendChild(tdTs);
        tr.appendChild(tdCombo);
        tr.appendChild(tdHit);
        tr.appendChild(tdDelete);

        logBody.appendChild(tr);
      }
    }

    function formatTs(tsISO) {
      const d = new Date(tsISO);
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${y}-${m}-${day} ${hh}:${mm}`;
    }

    // ---------- 抽選ロジック ----------
    function sortTicketsByRanks(tickets) {
      return tickets
        .map((t, idx) => ({ ...t, _idx: idx }))
        .sort((a, b) => {
          for (let i = 0; i < 5; i++) {
            const diff = a.ranks[i] - b.ranks[i];
            if (diff !== 0) return diff;
          }
          return a._idx - b._idx;
        })
        .map(({ _idx, ...rest }) => rest);
    }

    function weightedSampleRank(N, distType, distParam) {
      if (N <= 1) return 1;

      const weights = new Array(N);
      const s = clampFloat(distParam, 0, 2.5);
      for (let i = 0; i < N; i++) {
        const rank = i + 1;
        weights[i] = 1 / Math.pow(rank, Math.max(0.00001, s));
      }

      let sum = 0;
      for (let i = 0; i < N; i++) sum += weights[i];

      let r = Math.random() * sum;
      for (let i = 0; i < N; i++) {
        r -= weights[i];
        if (r <= 0) return i + 1;
      }
      return N;
    }

    // ---------- localStorage ----------
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(DEFAULT_STATE);
        const parsed = JSON.parse(raw);

        const s = structuredClone(DEFAULT_STATE);
        if (parsed && typeof parsed === "object") {
          if (parsed.settings && typeof parsed.settings === "object") {
            if (Array.isArray(parsed.settings.Ns) && parsed.settings.Ns.length === 5) {
              s.settings.Ns = parsed.settings.Ns.map(v => clampInt(parseInt(v,10), 1, 18));
            }
            s.settings.ticketsPerDraw = clampInt(parseInt(parsed.settings.ticketsPerDraw,10), 1, 50) || 1;
            s.settings.distType = "power";
            s.settings.distParam = Number.isFinite(parsed.settings.distParam) ? parsed.settings.distParam : 1.0;
          }
          if (Array.isArray(parsed.lastDrawTickets)) {
            s.lastDrawTickets = parsed.lastDrawTickets
              .filter(t => t && Array.isArray(t.ranks) && t.ranks.length === 5)
              .map(t => ({
                ranks: t.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                tsISO: (typeof t.tsISO === "string") ? t.tsISO : new Date().toISOString()
              }));
          }
          if (Array.isArray(parsed.log)) {
            s.log = parsed.log
              .filter(e => e && Array.isArray(e.ranks) && e.ranks.length === 5)
              .map(e => ({
                id: (typeof e.id === "string") ? e.id : `${Date.now()}-${Math.random().toString(16).slice(2)}`,
                tsISO: (typeof e.tsISO === "string") ? e.tsISO : new Date().toISOString(),
                ranks: e.ranks.map(v => clampInt(parseInt(v,10), 1, 18)),
                purchased: !!e.purchased,
                hit: !!e.hit
              }))
              .slice(0, MAX_LOG);
          }
        }
        return s;
      } catch {
        return structuredClone(DEFAULT_STATE);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch {
        // 保存失敗時は無視
      }
    }

    // ---------- ユーティリティ ----------
    function clampInt(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, Math.trunc(v)));
    }
    function clampFloat(v, min, max) {
      if (!Number.isFinite(v)) return min;
      return Math.max(min, Math.min(max, v));
    }

    function hydrateUI() {
      buildTicketsPerDraw();
      buildRaceCards();
      configureDistUIFromState();
      renderRaceWindowsFromTickets(state.lastDrawTickets);
      renderLog();
    }

    hydrateUI();
  </script>
</body>
</html>
